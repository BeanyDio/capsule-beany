// –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–æ–≤
const demoGiftIds = [8282, 26355, 9991, 7777];
const gifts = demoGiftIds.map(id => ({
  id,
  name: `NFT Gift #${id}`,
  price: id % 3 === 0 ? 9.9 : 19.5,
  image: `https://t.me/i/userpic/320/${id}.jpg`
}));

let cart = [];

function renderGifts(filter = "") {
  const grid = document.getElementById('gifts-grid');
  grid.innerHTML = '';
  gifts
    .filter(gift => !filter || gift.id.toString().includes(filter))
    .forEach(gift => {
      const card = document.createElement('div');
      card.className = 'gift-card';
      card.innerHTML = `
        <img src="${gift.image}" alt="${gift.name}" class="gift-img">
        <div class="gift-name">${gift.name}</div>
        <div class="gift-id">#${gift.id}</div>
        <div>
          <span class="gift-price">üíé ${gift.price}</span>
          <button class="add-cart-btn" onclick="addToCart(${gift.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
      `;
      grid.appendChild(card);
    });
}

function addToCart(id) {
  const gift = gifts.find(g => g.id === id);
  if (gift) {
    cart.push(gift);
    updateCartUI();
  }
}

function removeFromCart(index) {
  cart.splice(index, 1);
  updateCartUI();
}

function updateCartUI() {
  // –ö–æ—Ä–∑–∏–Ω–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  const badge = document.getElementById('cart-badge');
  if (!badge) return;

  badge.textContent = cart.length;
  badge.style.display = cart.length > 0 ? 'flex' : 'none';

  // –õ–æ–≥–∏–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã (–µ—Å–ª–∏ –æ–Ω–∞ –±—É–¥–µ—Ç)
}

document.addEventListener('DOMContentLoaded', function() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ Telegram WebApp
  // 'tdesktop' - —ç—Ç–æ –ü–ö-–≤–µ—Ä—Å–∏—è. –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ (android, ios) - –º–æ–±–∏–ª—å–Ω—ã–µ.
  if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.platform !== 'tdesktop') {
    document.body.classList.add('mobile');
  }

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö nav-btn
  Array.from(document.querySelectorAll('.nav-btn')).forEach(btn => {
    btn.addEventListener('click', function() {
      const tab = this.dataset.tab;
      switchTab(tab);
    });
  });

  // –ü–æ–∏—Å–∫ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ ID)
  const searchInput = document.getElementById('search-input');
  const clearSearchBtn = document.getElementById('clear-search-btn');

  if (searchInput && clearSearchBtn) {
    searchInput.addEventListener('input', function() {
      clearSearchBtn.style.display = this.value.length > 0 ? 'flex' : 'none';
      // –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    });

    clearSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      clearSearchBtn.style.display = 'none';
      searchInput.focus();
      searchInput.dispatchEvent(new Event('input'));
    });

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –≤–≤–æ–¥ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
    searchInput.addEventListener('beforeinput', function(e) {
      if (e.data !== null && !/^\d+$/.test(e.data)) {
        e.preventDefault();
      }
    });

    searchInput.addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const numbers = pastedText.replace(/\D/g, '');
      if (numbers) {
        document.execCommand('insertText', false, numbers);
      }
    });
  }

  // –õ–æ–≥–∏–∫–∞ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ (–≤ Collections)
  const searchInputCollections = document.getElementById('search-input-collections');
  const clearSearchBtnCollections = document.getElementById('clear-search-btn-collections');

  if (searchInputCollections && clearSearchBtnCollections) {
    searchInputCollections.addEventListener('input', function() {
      clearSearchBtnCollections.style.display = this.value.length > 0 ? 'flex' : 'none';
    });

    clearSearchBtnCollections.addEventListener('click', function() {
      searchInputCollections.value = '';
      clearSearchBtnCollections.style.display = 'none';
      searchInputCollections.focus();
    });
  }

  // --- –õ–û–ì–ò–ö–ê –û–ü–õ–ê–¢–´ ---
  // –í –±—É–¥—É—â–µ–º, —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
  let totalItems = 0; 

  const paymentSlider = document.getElementById('payment-slider');
  const paymentAmount = document.getElementById('payment-amount');
  const paymentItems = document.getElementById('payment-items');
  const payButton = document.querySelector('.payment-button');

  if (paymentSlider && paymentAmount && payButton && paymentItems) {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º —Å–ª–∞–π–¥–µ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª-–≤–∞ –∏—Ç–µ–º–æ–≤
    paymentSlider.max = totalItems;
    paymentSlider.value = 0; // –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω—É–ª—è

    const updateSliderStyle = () => {
      const value = parseFloat(paymentSlider.value) || 0;
      const min = parseFloat(paymentSlider.min) || 0;
      const max = parseFloat(paymentSlider.max) || 0;
      
      let progress = 0;
      if (max > min) {
        progress = ((value - min) / (max - min)) * 100;
      }
      
      paymentSlider.style.background = `linear-gradient(to right, #fff ${progress}%, #6D6D71 ${progress}%)`;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
      if (value === 0) {
        payButton.style.backgroundColor = '#1F5893';
        payButton.style.color = '#8E9093';
        payButton.disabled = true;
      } else {
        payButton.style.backgroundColor = '#0A84FF';
        payButton.style.color = '#fff';
        payButton.disabled = false;
      }
    };

    paymentSlider.addEventListener('input', function() {
      const currentValue = Math.round(this.value);
      paymentAmount.textContent = `${currentValue} TON`; // –ü—Ä–∏–º–µ—Ä, —Ü–µ–Ω–∞ –±—É–¥–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –∏—Ç–µ–º–æ–≤
      paymentItems.textContent = `${currentValue} items`;
      updateSliderStyle();
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    paymentAmount.textContent = `0 TON`;
    paymentItems.textContent = `0 items`;
    updateSliderStyle();
  }

  // --- –õ–û–ì–ò–ö–ê –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ---
  const rulesBtn = document.getElementById('rules-btn-display');
  const modalOverlay = document.getElementById('rules-modal-overlay');
  const closeModalBtn = document.getElementById('modal-close-btn');
  const continueBtn = document.getElementById('modal-continue-btn');

  const openModal = () => {
    if (!modalOverlay) return;
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –∏ –±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
    modalOverlay.style.display = 'flex';
    modalOverlay.classList.add('visible'); // –°–†–ê–ó–£ –≤–∫–ª—é—á–∞–µ–º –±–ª—é—Ä
    document.body.classList.add('modal-open');
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å
    const panel = modalOverlay.querySelector('.modal-panel');
    if (panel) {
      panel.classList.remove('slide-in'); // —Å–±—Ä–æ—Å, —á—Ç–æ–±—ã transition –≤—Å–µ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª
      // –¢—Ä–∏–≥–≥–µ—Ä–∏–º reflow –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
      void panel.offsetWidth;
      panel.classList.add('slide-in');
    }
  };

  const closeModal = () => {
    if (!modalOverlay) return;
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å–∫—Ä—ã—Ç–∏—è
    modalOverlay.classList.remove('visible');
    const panel = modalOverlay.querySelector('.modal-panel');
    if (panel) {
      panel.classList.remove('slide-in');
    }
    // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π —á–µ—Ä–µ–∑ display:none
    const onTransitionEnd = () => {
      modalOverlay.style.display = 'none';
      document.body.classList.remove('modal-open');
      if (panel) panel.removeEventListener('transitionend', onTransitionEnd);
    };
    if (panel) {
      panel.addEventListener('transitionend', onTransitionEnd, {once: true});
    } else {
      setTimeout(() => {
        modalOverlay.style.display = 'none';
        document.body.classList.remove('modal-open');
      }, 800);
    }
  };

  rulesBtn?.addEventListener('click', openModal);
  closeModalBtn?.addEventListener('click', closeModal);
  continueBtn?.addEventListener('click', closeModal);
  modalOverlay?.addEventListener('click', (e) => {
    if (e.target === modalOverlay) {
      closeModal();
    }
  });

  // –ö–Ω–æ–ø–∫–∏
  const cartPayBtn = document.getElementById('cart-pay-btn');
  if (cartPayBtn) {
    cartPayBtn.onclick = function() {
      if (cart.length === 0) return;
      alert('‚úÖ –û–ø–ª–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! (–î–µ–º–æ)');
      cart = [];
      updateCartUI();
    };
  }
  const walletBtn = document.getElementById('wallet-btn');
  if (walletBtn) {
    walletBtn.onclick = function() {
      alert('TonConnect –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –¥–µ–º–æ');
    };
  }
  const topupBtn = document.getElementById('topup-btn');
  if (topupBtn) {
    topupBtn.onclick = function() {
      alert('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –¥–µ–º–æ');
    };
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  updateCartUI();
  switchTab('market');

  // Telegram WebApp Fullscreen
  if (window.Telegram && window.Telegram.WebApp) {
    let tg = window.Telegram.WebApp;
    tg.ready();
    // –ü—Ä–æ—Å—Ç–æ —Ä–∞—Å—à–∏—Ä—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—è –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
    if (tg.expand) {
      tg.expand();
    }
  }

  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–∞–±–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞
  const storeTabs = document.querySelector('.store-tabs');
  const tabAllBtn = document.getElementById('tab-all');
  const tabCollectionsBtn = document.getElementById('tab-collections');
  const allContent = document.getElementById('store-all-content');
  const collectionsContent = document.getElementById('store-collections-content');

  function switchStoreTab(tab) {
    if (tab === 'all') {
      tabAllBtn.classList.add('active');
      tabCollectionsBtn.classList.remove('active');
      allContent.classList.add('active');
      collectionsContent.classList.remove('active');
    } else {
      tabAllBtn.classList.remove('active');
      tabCollectionsBtn.classList.add('active');
      allContent.classList.remove('active');
      collectionsContent.classList.add('active');
    }
  }

  if (storeTabs) {
    storeTabs.addEventListener('click', function(e) {
      const target = e.target.closest('.store-tab-btn');
      if (target) {
        if (target.id === 'tab-all') {
          switchStoreTab('all');
        } else if (target.id === 'tab-collections') {
          switchStoreTab('collections');
        }
      }
    });
    switchStoreTab('all');
  }

  // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ Store
  const activityBtn = document.getElementById('activity-btn');
  const viewBtn = document.getElementById('view-btn');
  const filterBtn = document.getElementById('filter-btn');

  activityBtn?.addEventListener('click', () => activityBtn.classList.toggle('active'));
  viewBtn?.addEventListener('click', () => viewBtn.classList.toggle('active'));
  filterBtn?.addEventListener('click', () => filterBtn.classList.toggle('active'));

  const profileBtn = document.getElementById('nav-profile');
  const marketBtn = document.getElementById('nav-market');
  const giftsBtn = document.getElementById('nav-gifts');
  const seasonsBtn = document.getElementById('nav-seasons');
  const bonusBalance = document.getElementById('bonus-balance-display');
  const settingsIcon = document.getElementById('settings-icon');

  function showSettingsIcon() {
    bonusBalance.style.display = 'none';
    settingsIcon.style.display = 'flex';
  }

  function showBonusBalance() {
    bonusBalance.style.display = 'flex';
    settingsIcon.style.display = 'none';
  }

  function hideBonusAndSettings() {
    bonusBalance.style.display = 'none';
    settingsIcon.style.display = 'none';
  }

  profileBtn.addEventListener('click', showSettingsIcon);
  marketBtn.addEventListener('click', showBonusBalance);
  giftsBtn.addEventListener('click', showBonusBalance);
  seasonsBtn.addEventListener('click', hideBonusAndSettings);

  const closeBtn = document.getElementById('modal-close-btn');
  if (closeBtn && modalOverlay) {
    closeBtn.addEventListener('click', function() {
      modalOverlay.classList.remove('visible');
    });
  }

  if (bonusBalance) {
    bonusBalance.addEventListener('click', function() {
      switchTab('seasons');
    });
  }

  const depositBtn = document.querySelector('.ton-plus');
  const depositSection = document.getElementById('deposit-section');
  const mainContainer = document.querySelector('.container');
  const depositBackBtn = document.getElementById('deposit-back-btn');
  const bottomNav = document.querySelector('.bottom-nav');

  function openDeposit() {
    if (depositSection) {
      depositSection.classList.remove('hide');
      depositSection.classList.add('show');
      depositSection.style.display = 'flex';
      if (mainContainer) mainContainer.style.display = 'none';
      if (bottomNav) bottomNav.style.display = 'none';
      if (location.hash !== '#deposit') {
        history.pushState({deposit: true}, '', '#deposit');
      }
    }
  }
  function closeDeposit() {
    if (depositSection) {
      depositSection.classList.remove('show');
      depositSection.classList.add('hide');
      setTimeout(() => {
        depositSection.style.display = 'none';
      }, 400);
    }
    if (mainContainer) mainContainer.style.display = '';
    if (bottomNav) bottomNav.style.display = '';
  }
  if (depositBtn) {
    depositBtn.addEventListener('click', openDeposit);
  }
  if (depositBackBtn) {
    depositBackBtn.addEventListener('click', function() {
      history.back();
    });
  }
  window.addEventListener('popstate', function(e) {
    if (e.state && e.state.deposit) {
      openDeposit();
    } else {
      closeDeposit();
    }
  });
});

/**
 * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –∏ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
 */
function switchTab(tab) {
  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–µ–∫—Ü–∏–∏
  const sections = ['market', 'gifts', 'seasons', 'profile', 'cart'];
  sections.forEach(name => {
    const el = document.getElementById(name + '-section');
    if (el) {
      el.classList.toggle('active-section', tab === name);
    }
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–æ–Ω—É—Å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ / –∫–Ω–æ–ø–∫–∏ Rules
  const bonusDisplay = document.getElementById('bonus-balance-display');
  const rulesDisplay = document.getElementById('rules-btn-display');

  if (bonusDisplay && rulesDisplay) {
    if (tab === 'seasons') {
      bonusDisplay.style.display = 'none';
      rulesDisplay.style.display = 'flex';
    } else {
      bonusDisplay.style.display = 'flex';
      rulesDisplay.style.display = 'none';
    }
  }
}

async function initTg() {
  if (window.Telegram?.isTMA && await window.Telegram.isTMA()) {
    window.Telegram.init();
    
    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ expand, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–ª–æ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ
    if (window.Telegram.WebApp?.expand) {
      window.Telegram.WebApp.expand();
    }
  }
}

(async () => { await initTg(); })();

function isMobile() {
  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
}

document.querySelector('.custom-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
